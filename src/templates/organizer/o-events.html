{% extends 'organizer/o-base.html' %}
{% block title %}Events{% endblock %}
{% block topbar %}
<div class="d-flex justify-content-between align-items-center mb-4">
  <h2 class="m-0">Manage Events</h2>
  <div class="d-flex align-items-center gap-3">
    <div class="form-check form-switch">
      <input class="form-check-input" type="checkbox" role="switch" id="modeToggle">
      <label class="form-check-label muted" for="modeToggle">Offline / Online</label>
    </div>
    <button class="icon-btn" id="themeToggle" title="Toggle Dark/Light">
      <svg id="moonIcon" viewBox="0 0 24 24"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>
      <svg id="sunIcon" viewBox="0 0 24 24" style="display:none"><circle cx="12" cy="12" r="4"/><path d="M12 2v2M12 20v2M20 12h2M2 12H4M18.36 5.64l1.41-1.41M4.23 19.78l1.41-1.41M18.36 18.36l1.41 1.41M4.23 4.22l1.41 1.41"/></svg>
    </button>
  </div>
</div>
{% endblock %}
{% block content %}
<div class="card p-3">
  <div class="d-flex justify-content-between align-items-center mb-2">
    <div class="muted">Your Events</div>
    <div class="small muted">Total: {{ events|length if events is defined else 0 }}</div>
  </div>
  <table class="table table-hover" id="eventsTable">
    <thead>
      <tr><th>#</th><th>Event Name</th><th>Date</th><th>Mode</th><th>Status</th></tr>
    </thead>
    <tbody>
    {% if events is defined and events|length > 0 %}
      {% for e in events %}
        {% set status = 'Ongoing' %}
        {% set badge = 'success' %}
        {% if e.start_date > now %}{% set status = 'Upcoming' %}{% set badge='warning' %}{% elif e.end_date < now %}{% set status = 'Completed' %}{% set badge='secondary' %}{% endif %}
        <tr>
          <td>{{ loop.index }}</td>
          <td>{{ e.name }}</td>
          <td>{{ e.start_date.strftime('%Y-%m-%d') }} → {{ e.end_date.strftime('%Y-%m-%d') }}</td>
          <td>{{ 'Online' if (e.rules and 'online' in e.rules|lower) else 'Offline' }}</td>
          <td><span class="badge bg-{{ badge }}">{{ status }}</span></td>
        </tr>
      {% endfor %}
    {% else %}
      <tr>
        <td colspan="5" class="text-center text-muted py-4">
          No events created yet.<br>
          <span class="d-block mt-2 small">If you expected data:
            <ul class="list-unstyled mt-2 mb-0">
              <li>• Ensure you're logged in as the creating organizer.</li>
              <li>• Run <code>flask seed-events</code> for sample events.</li>
              <li>• Restart server after migrations.</li>
            </ul>
          </span>
        </td>
      </tr>
    {% endif %}
    </tbody>
  </table>
  {% if not (events is defined and events|length > 0) %}
  <div class="mt-3">
    <form class="row g-2" method="post" action="{{ url_for('events.create_event') }}" onsubmit="return confirm('Create a quick sample event?');">
      <input type="hidden" name="created_by" value="{{ session.get('user_id') }}">
      <div class="col-md-3"><input required name="name" class="form-control form-control-sm" placeholder="Event name"></div>
      <div class="col-md-2"><input required type="date" name="start_date" class="form-control form-control-sm" value="{{ now.strftime('%Y-%m-%d') }}"></div>
      <div class="col-md-2"><input required type="date" name="end_date" class="form-control form-control-sm" value="{{ (now + timedelta(days=2)).strftime('%Y-%m-%d') }}"></div>
      <div class="col-md-3"><input name="theme" class="form-control form-control-sm" placeholder="Theme"></div>
      <div class="col-md-2 d-grid"><button class="btn btn-sm btn-primary">Quick Add</button></div>
    </form>
  </div>
  {% endif %}
</div>
{% endblock %}
{% block scripts %}{% endblock %}
                      <li>• Make sure you're logged in as an organizer who owns events (created_by matches your user_id).</li>
                      <li>• Run <code>flask seed-events</code> to add sample events (development only).</li>
                      <li>• Confirm server restarted after code changes.</li>
                    </ul>
                  </span>
                </td>
              </tr>
            {% endif %}
          </tbody>
        </table>
        {% if not (events is defined and events|length > 0) %}
        <div class="mt-3">
          <form class="row g-2" method="post" action="{{ url_for('events.create_event') }}" onsubmit="return confirm('Create a quick sample event?');">
            <input type="hidden" name="created_by" value="{{ session.get('user_id') }}">
            <div class="col-md-3">
              <input required name="name" class="form-control form-control-sm" placeholder="Event name">
            </div>
            <div class="col-md-2">
              <input required type="date" name="start_date" class="form-control form-control-sm" value="{{ now.strftime('%Y-%m-%d') }}">
            </div>
            <div class="col-md-2">
              <input required type="date" name="end_date" class="form-control form-control-sm" value="{{ (now + timedelta(days=2)).strftime('%Y-%m-%d') }}">
            </div>
            <div class="col-md-3">
              <input name="theme" class="form-control form-control-sm" placeholder="Theme">
            </div>
            <div class="col-md-2 d-grid">
              <button class="btn btn-sm btn-primary">Quick Add</button>
            </div>
          </form>
        </div>
        {% endif %}
      </div>
    </main>
  </div>
</div>
<script>
const themeBtn = document.getElementById("themeToggle");
const moonIcon = document.getElementById("moonIcon");
const sunIcon  = document.getElementById("sunIcon");
const modeToggle = document.getElementById("modeToggle");

// --- Theme functions ---
function setTheme(theme) {
  document.body.setAttribute('data-theme', theme);
  localStorage.setItem('theme', theme); // save theme
  const dark = theme === 'dark';
  moonIcon.style.display = dark ? 'none' : 'block';
  sunIcon.style.display  = dark ? 'block' : 'none';
}

// Toggle dark/light
themeBtn.addEventListener("click", () => {
  const current = document.body.getAttribute('data-theme') === 'dark' ? 'dark' : 'light';
  setTheme(current === 'dark' ? 'light' : 'dark');
  refreshChartTheme();   // ✅ make charts update colors
});


// Apply saved theme on page load
const savedTheme = localStorage.getItem('theme') || 'light';
setTheme(savedTheme);

// --- Online/Offline functions ---
function setMode(mode) {
  modeToggle.checked = (mode === 'online'); // checked = online
  localStorage.setItem('mode', mode);
  // You can add any logic to load page-specific data here
  // For example: fetchSettingsData(mode);
}

// Toggle online/offline
modeToggle.addEventListener("change", function() {
  const mode = this.checked ? 'online' : 'offline';
  setMode(mode);
  alert(`Switched to ${mode.charAt(0).toUpperCase() + mode.slice(1)} mode`);
});

// Apply saved mode on page load
const savedMode = localStorage.getItem('mode') || 'offline';
setMode(savedMode);

</script>
</body>
</html>
